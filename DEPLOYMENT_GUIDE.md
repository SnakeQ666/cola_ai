# ðŸš€ éƒ¨ç½²æŒ‡å— - é˜¿é‡Œäº‘ Serverless æ–¹æ¡ˆ

## ðŸ“‹ éƒ¨ç½²æž¶æž„

- **åº”ç”¨æ‰˜ç®¡**: é˜¿é‡Œäº‘ SAE (Serverless Application Engine)
- **æ•°æ®åº“**: é˜¿é‡Œäº‘ RDS PostgreSQL
- **æ–‡ä»¶å­˜å‚¨**: é˜¿é‡Œäº‘ OSS
- **åŸŸå**: å·²å¤‡æ¡ˆåŸŸå

---

## ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡é˜¿é‡Œäº‘èµ„æº

### 1.1 åˆ›å»º RDS PostgreSQL æ•°æ®åº“

```bash
1. ç™»å½•é˜¿é‡Œäº‘æŽ§åˆ¶å°
2. è¿›å…¥ RDS â†’ åˆ›å»ºå®žä¾‹
3. é€‰æ‹©ï¼š
   - å¼•æ“Žï¼šPostgreSQL 14+
   - è§„æ ¼ï¼š2æ ¸4GBï¼ˆåŸºç¡€ç‰ˆè¶³å¤Ÿï¼‰
   - å­˜å‚¨ï¼š20GB SSD
   - åœ°åŸŸï¼šé€‰æ‹©ç¦»ä½ è¿‘çš„ï¼ˆå¦‚åŽä¸œã€åŽå—ï¼‰
4. åˆ›å»ºåŽï¼Œè®°å½•ï¼š
   - å†…ç½‘åœ°å€ï¼ˆendpointï¼‰
   - ç«¯å£ï¼ˆé»˜è®¤5432ï¼‰
   - ç”¨æˆ·å/å¯†ç 
5. ç™½åå•è®¾ç½®ï¼š
   - æ·»åŠ  0.0.0.0/0ï¼ˆä¸´æ—¶ï¼ŒåŽç»­æ”¹ä¸º SAE IPï¼‰
```

### 1.2 OSS å·²é…ç½® âœ…

ä½ çš„ OSS é…ç½®ï¼š
- Region: `ap-southeast-1`
- Bucket: å·²åˆ›å»º
- Access Key ID: å·²æœ‰
- Access Key Secret: å·²æœ‰

### 1.3 åˆ›å»º SAE åº”ç”¨

```bash
1. è¿›å…¥ SAE æŽ§åˆ¶å° â†’ åˆ›å»ºåº”ç”¨
2. é€‰æ‹©ï¼š
   - éƒ¨ç½²æ–¹å¼ï¼šé•œåƒ
   - åœ°åŸŸï¼šä¸Ž RDS åŒåœ°åŸŸ
   - VPCï¼šé€‰æ‹©æˆ–åˆ›å»ºï¼ˆä¸Ž RDS åœ¨åŒä¸€ä¸ª VPCï¼‰
3. è§„æ ¼ï¼š
   - å®žä¾‹ï¼š0.5æ ¸1GBï¼ˆå¯åŽç»­è°ƒæ•´ï¼‰
   - å®žä¾‹æ•°é‡ï¼š1ï¼ˆè‡ªåŠ¨ä¼¸ç¼©å¯è®¾ç½® 1-3ï¼‰
```

---

## ç¬¬äºŒæ­¥ï¼šé…ç½®çŽ¯å¢ƒå˜é‡

åˆ›å»º `.env.production` æ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ° Gitï¼‰ï¼š

```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL="postgresql://ç”¨æˆ·å:å¯†ç @your-rds.mysql.rds.aliyuncs.com:5432/ai_data_analysis"

# NextAuth é…ç½®
NEXTAUTH_URL="https://your-domain.com"
NEXTAUTH_SECRET="ç”Ÿæˆçš„å¯†é’¥"  # è¿è¡Œ: openssl rand -base64 32

# Dify API
DIFY_API_KEY="app-ä½ çš„Difyå¯†é’¥"
DIFY_API_URL="https://api.dify.ai/v1"

# é˜¿é‡Œäº‘ OSS
ALIYUN_OSS_REGION="ap-southeast-1"
ALIYUN_OSS_BUCKET="ä½ çš„bucketåç§°"
ALIYUN_OSS_ACCESS_KEY_ID="ä½ çš„AccessKeyId"
ALIYUN_OSS_ACCESS_KEY_SECRET="ä½ çš„AccessKeySecret"
ALIYUN_OSS_ENDPOINT="https://oss-ap-southeast-1.aliyuncs.com"
```

### ç”Ÿæˆ NEXTAUTH_SECRETï¼š

```bash
openssl rand -base64 32
```

---

## ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

### 3.1 æœ¬åœ°è¿žæŽ¥ RDS

```bash
# å®‰è£… PostgreSQL å®¢æˆ·ç«¯ï¼ˆå¦‚æžœæ²¡æœ‰ï¼‰
# macOS:
brew install postgresql

# æµ‹è¯•è¿žæŽ¥
psql "postgresql://ç”¨æˆ·å:å¯†ç @your-rds-endpoint:5432/postgres"
```

### 3.2 æŽ¨é€æ•°æ®åº“ç»“æž„

```bash
# ç¡®ä¿ .env.production ä¸­çš„ DATABASE_URL æ­£ç¡®

# æŽ¨é€ Prisma schema åˆ°æ•°æ®åº“
npx prisma db push

# ç”Ÿæˆ Prisma Client
npx prisma generate
```

---

## ç¬¬å››æ­¥ï¼šæž„å»º Docker é•œåƒ

### 4.1 åˆ›å»º Dockerfile

æˆ‘å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†ï¼Œæ£€æŸ¥ä¸€ä¸‹é¡¹ç›®æ ¹ç›®å½•çš„ `Dockerfile`

### 4.2 åˆ›å»º .dockerignore

æ£€æŸ¥ `.dockerignore` æ–‡ä»¶

### 4.3 æž„å»ºé•œåƒ

```bash
# æž„å»ºé•œåƒ
docker build -t ai-data-analysis:v1.0.0 .

# æµ‹è¯•é•œåƒï¼ˆå¯é€‰ï¼‰
docker run -p 3000:3000 --env-file .env.production ai-data-analysis:v1.0.0
```

---

## ç¬¬äº”æ­¥ï¼šæŽ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡

### 5.1 å¼€é€šå®¹å™¨é•œåƒæœåŠ¡ ACR

```bash
1. é˜¿é‡Œäº‘æŽ§åˆ¶å° â†’ å®¹å™¨é•œåƒæœåŠ¡
2. åˆ›å»ºå‘½åç©ºé—´ï¼šai-apps
3. åˆ›å»ºé•œåƒä»“åº“ï¼šai-data-analysis
4. é€‰æ‹©ï¼šç§æœ‰
```

### 5.2 ç™»å½•å¹¶æŽ¨é€

```bash
# ç™»å½• ACRï¼ˆæ›¿æ¢ä¸ºä½ çš„åœ°åŸŸï¼‰
docker login --username=ä½ çš„é˜¿é‡Œäº‘è´¦å· registry.cn-hangzhou.aliyuncs.com

# æ‰“æ ‡ç­¾
docker tag ai-data-analysis:v1.0.0 \
  registry.cn-hangzhou.aliyuncs.com/ai-apps/ai-data-analysis:v1.0.0

# æŽ¨é€
docker push registry.cn-hangzhou.aliyuncs.com/ai-apps/ai-data-analysis:v1.0.0
```

---

## ç¬¬å…­æ­¥ï¼šåœ¨ SAE éƒ¨ç½²åº”ç”¨

### 6.1 é…ç½®åº”ç”¨

```bash
1. SAE æŽ§åˆ¶å° â†’ é€‰æ‹©åº”ç”¨ â†’ éƒ¨ç½²åº”ç”¨
2. é•œåƒåœ°å€ï¼š
   registry.cn-hangzhou.aliyuncs.com/ai-apps/ai-data-analysis:v1.0.0
3. çŽ¯å¢ƒå˜é‡ï¼ˆé‡è¦ï¼ï¼‰ï¼š
   ç‚¹å‡»"æ·»åŠ çŽ¯å¢ƒå˜é‡" â†’ ç²˜è´´ .env.production çš„æ‰€æœ‰å†…å®¹
4. å¥åº·æ£€æŸ¥ï¼š
   - è·¯å¾„ï¼š/api/health
   - ç«¯å£ï¼š3000
5. å¯åŠ¨å‘½ä»¤ï¼š
   å‘½ä»¤ï¼šnode
   å‚æ•°ï¼šserver.js
```

### 6.2 é…ç½®ç½‘ç»œ

```bash
1. VPC é…ç½®ï¼š
   - ç¡®ä¿ SAE ä¸Ž RDS åœ¨åŒä¸€ VPC
   - å®‰å…¨ç»„å…è®¸ 5432 ç«¯å£
2. å…¬ç½‘è®¿é—®ï¼š
   - ç»‘å®š SLBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
   - æˆ–ä½¿ç”¨ SAE è‡ªå¸¦åŸŸåæµ‹è¯•
```

---

## ç¬¬ä¸ƒæ­¥ï¼šé…ç½®åŸŸå

### 7.1 åœ¨ SAE ç»‘å®šåŸŸå

```bash
1. SAE åº”ç”¨ â†’ è®¿é—®é…ç½® â†’ ç»‘å®šåŸŸå
2. æ·»åŠ ä½ çš„åŸŸåï¼šyour-domain.com
3. é…ç½® HTTPSï¼š
   - ä¸Šä¼  SSL è¯ä¹¦
   - æˆ–ä½¿ç”¨å…è´¹è¯ä¹¦
```

### 7.2 é…ç½® DNS

```bash
åˆ°ä½ çš„åŸŸåæœåŠ¡å•†ï¼ˆé˜¿é‡Œäº‘ï¼‰ï¼š
1. æ·»åŠ  CNAME è®°å½•
2. è®°å½•å€¼ï¼šSAE æä¾›çš„åœ°å€
3. ç­‰å¾…ç”Ÿæ•ˆï¼ˆé€šå¸¸å‡ åˆ†é’Ÿï¼‰
```

---

## ç¬¬å…«æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 8.1 å¥åº·æ£€æŸ¥

åˆ›å»ºå¥åº·æ£€æŸ¥ APIï¼ˆæˆ‘æ¥å¸®ä½ åˆ›å»ºï¼‰

### 8.2 æµ‹è¯•åŠŸèƒ½

```bash
1. è®¿é—® https://your-domain.com
2. æµ‹è¯•æ³¨å†Œ/ç™»å½•
3. ä¸Šä¼ æ•°æ®é›†ï¼ˆæµ‹è¯• OSSï¼‰
4. AI å¯¹è¯ï¼ˆæµ‹è¯• Difyï¼‰
5. ç”Ÿæˆå›¾è¡¨
```

---

## ðŸ”§ åŽç»­ä¼˜åŒ–

### ç›‘æŽ§å’Œæ—¥å¿—

```bash
1. SAE æŽ§åˆ¶å° â†’ åº”ç”¨ç›‘æŽ§
2. æŸ¥çœ‹å®žæ—¶æ—¥å¿—
3. é…ç½®å‘Šè­¦è§„åˆ™
```

### è‡ªåŠ¨æ‰©ç¼©å®¹

```bash
1. SAE â†’ å¼¹æ€§ä¼¸ç¼©
2. é…ç½®è§„åˆ™ï¼š
   - CPU > 70% æ‰©å®¹
   - CPU < 30% ç¼©å®¹
   - æœ€å°å®žä¾‹ï¼š1
   - æœ€å¤§å®žä¾‹ï¼š3
```

### å¤‡ä»½ç­–ç•¥

```bash
1. RDS è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯å¤©ï¼‰
2. OSS ç‰ˆæœ¬æŽ§åˆ¶
3. å®šæœŸå¯¼å‡ºæ•°æ®
```

---

## ðŸ“ å¸¸è§é—®é¢˜

### 1. æ•°æ®åº“è¿žæŽ¥å¤±è´¥

```bash
æ£€æŸ¥ï¼š
- RDS ç™½åå•æ˜¯å¦åŒ…å« SAE IP
- DATABASE_URL æ ¼å¼æ˜¯å¦æ­£ç¡®
- VPC å’Œå®‰å…¨ç»„é…ç½®
```

### 2. OSS ä¸Šä¼ å¤±è´¥

```bash
æ£€æŸ¥ï¼š
- Access Key æ˜¯å¦æ­£ç¡®
- Bucket æƒé™è®¾ç½®
- CORS é…ç½®ï¼ˆå¦‚æžœå‰ç«¯ç›´ä¼ ï¼‰
```

### 3. åº”ç”¨å¯åŠ¨å¤±è´¥

```bash
æŸ¥çœ‹ SAE æ—¥å¿—ï¼š
- æ£€æŸ¥çŽ¯å¢ƒå˜é‡
- æŸ¥çœ‹é”™è¯¯å †æ ˆ
- ç¡®è®¤é•œåƒæ˜¯å¦æ­£ç¡®
```

---

## ðŸŽ¯ ä¸‹ä¸€æ­¥

éƒ¨ç½²å®ŒæˆåŽï¼Œå‘Šè¯‰æˆ‘é‡åˆ°çš„ä»»ä½•é—®é¢˜ï¼

æˆ‘è¿˜éœ€è¦ä¸ºä½ åˆ›å»ºï¼š
1. âœ… Dockerfile
2. âœ… .dockerignore  
3. âœ… å¥åº·æ£€æŸ¥ API
4. âš ï¸ CI/CD è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ï¼ˆå¯é€‰ï¼‰

**çŽ°åœ¨è¦æˆ‘å…ˆå¸®ä½ åˆ›å»ºè¿™äº›æ–‡ä»¶å—ï¼Ÿ**

