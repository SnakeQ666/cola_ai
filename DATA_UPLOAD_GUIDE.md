# 📤 数据上传功能使用指南

## 🎉 已完成的功能

### ✅ 核心功能
- 文件上传到阿里云OSS
- 支持CSV、Excel (.xlsx, .xls)、JSON格式
- 自动解析数据
- 数据预览
- 数据集管理
- 搜索和删除

### ✅ 安全特性
- 用户认证（只能访问自己的数据）
- 文件大小限制（50MB）
- 文件类型验证
- OSS签名URL（临时访问）

---

## 🚀 快速开始

### 1️⃣ 测试OSS配置

访问：http://localhost:3000/test-oss

点击"开始测试"按钮，确保看到"✅ OSS配置正确"

**如果测试失败**：
- 检查 `.env` 文件中的OSS配置
- 确保所有环境变量都已填写
- 重启开发服务器（Ctrl+C 然后 `pnpm dev`）

---

### 2️⃣ 上传第一个数据集

#### 步骤：

1. **登录系统**
   - 访问 http://localhost:3000/auth/login
   - 使用已注册的账号登录

2. **进入数据集页面**
   - 访问 http://localhost:3000/datasets
   - 或点击左侧导航"数据集"

3. **点击"上传数据"按钮**
   - 会弹出上传对话框

4. **选择文件**
   - 拖拽文件到虚线框内
   - 或点击虚线框选择文件

5. **点击"开始上传"**
   - 等待上传完成
   - 上传成功后会自动刷新列表

---

## 📁 支持的文件格式

### CSV文件 (.csv)

```csv
name,age,city,salary
张三,25,北京,10000
李四,30,上海,15000
王五,28,深圳,12000
```

### Excel文件 (.xlsx, .xls)

- 支持标准Excel格式
- 读取第一个工作表
- 第一行作为列名

### JSON文件 (.json)

```json
[
  {"name": "张三", "age": 25, "city": "北京", "salary": 10000},
  {"name": "李四", "age": 30, "city": "上海", "salary": 15000},
  {"name": "王五", "age": 28, "city": "深圳", "salary": 12000}
]
```

**注意**：
- 必须是JSON数组格式
- 每个对象的键会作为列名

---

## 💡 功能详解

### 数据集列表页面

**功能**：
- ✅ 查看所有上传的数据集
- ✅ 搜索数据集
- ✅ 查看数据集信息（行数、列数、大小）
- ✅ 预览数据
- ✅ 分析数据
- ✅ 删除数据集

**界面说明**：
- 绿色标签"就绪"：数据集已准备好
- 黄色标签"处理中"：正在处理（正常情况应该很快完成）

### 数据预览页面

访问：点击数据集卡片的"预览"按钮

**功能**：
- ✅ 查看数据集详细信息
- ✅ 查看列信息（名称、类型）
- ✅ 预览前50行数据
- ✅ 下载原始文件
- ✅ 跳转到AI分析
- ✅ 创建可视化

---

## 🔍 工作流程

### 上传流程

```
1. 用户选择文件
   ↓
2. 前端验证（大小、格式）
   ↓
3. 上传到后端API (/api/datasets/upload)
   ↓
4. 解析文件数据
   ├─ 检测列类型
   ├─ 统计行数、列数
   └─ 生成数据预览
   ↓
5. 上传文件到OSS
   ↓
6. 保存数据集信息到数据库
   ↓
7. 返回成功，刷新列表
```

### 查看流程

```
1. 用户点击"预览"
   ↓
2. 获取数据集信息 (/api/datasets/[id])
   ↓
3. 获取数据内容 (/api/datasets/[id]/data)
   ↓
4. 从OSS下载文件
   ↓
5. 解析并返回数据
   ↓
6. 显示在表格中
```

---

## 📊 数据解析说明

### 自动类型检测

系统会自动检测每列的数据类型：

- **number**：纯数字列
- **boolean**：布尔值（true/false）
- **date**：日期格式（YYYY-MM-DD）
- **string**：字符串（默认）

### 列信息

```typescript
{
  name: "age",        // 列名
  type: "number",     // 数据类型
  nullable: false,    // 是否有空值
  sample: [25, 30, 28]  // 示例数据
}
```

---

## 🎯 实际使用场景

### 场景1：销售数据分析

1. 准备CSV文件（销售记录）
2. 上传到系统
3. 点击"分析"进入AI分析
4. 问AI："分析销售趋势"

### 场景2：用户数据可视化

1. 上传用户数据（JSON或Excel）
2. 点击"预览"查看数据
3. 点击"创建可视化"
4. AI自动推荐图表类型

---

## 🛠️ 测试数据

### 创建测试CSV文件

**sales.csv**
```csv
日期,产品,销量,金额
2024-01-01,iPhone,100,99900
2024-01-02,MacBook,50,74950
2024-01-03,iPad,80,43920
2024-01-04,iPhone,120,119880
2024-01-05,MacBook,60,89940
```

保存为CSV文件后上传测试。

### 创建测试JSON文件

**users.json**
```json
[
  {"name": "张三", "age": 25, "city": "北京", "vip": true},
  {"name": "李四", "age": 30, "city": "上海", "vip": false},
  {"name": "王五", "age": 28, "city": "深圳", "vip": true},
  {"name": "赵六", "age": 35, "city": "广州", "vip": true}
]
```

---

## 🐛 常见问题

### Q1: 上传失败，提示"OSS上传失败"？

**解决方案**：
1. 检查OSS配置是否正确
2. 访问 `/test-oss` 测试连接
3. 确认AccessKey有OSS权限
4. 检查Bucket名称是否正确

### Q2: 上传后看不到数据？

**解决方案**：
1. 刷新页面
2. 检查浏览器控制台错误
3. 查看数据集状态是否为"就绪"

### Q3: 预览数据时加载很慢？

**原因**：文件较大，需要从OSS下载并解析

**优化**：
- 只预览前50行
- 大文件建议直接用AI分析

### Q4: 支持多大的文件？

**限制**：
- 最大50MB
- 建议单个文件不超过10MB以获得最佳体验
- 超大文件建议分批上传

### Q5: 删除数据集后能恢复吗？

**注意**：
- 删除操作不可逆
- 建议删除前下载备份

---

## 📂 文件存储位置

### OSS路径结构

```
oss://your-bucket/
  └── dataset/
      └── {userId}/
          └── {timestamp}-{filename}
```

例如：
```
dataset/clp123abc/1704067200000-sales.csv
```

---

## 🔐 安全说明

### 权限控制

- ✅ 只能访问自己上传的数据集
- ✅ API会验证用户ID
- ✅ OSS使用签名URL（5分钟有效期）

### 数据隐私

- 文件存储在您的OSS Bucket
- 不会被其他用户访问
- 建议设置Bucket为私有访问

---

## 🎉 下一步

现在您可以：

1. ✅ **测试上传功能**
   - 上传测试文件
   - 查看数据预览

2. ✅ **准备真实数据**
   - 整理业务数据
   - 转换为支持的格式

3. ✅ **开始AI分析**
   - 下一步我们会实现AI对话分析功能
   - 可以用自然语言分析数据

---

## 📞 需要帮助？

如果遇到问题：
1. 查看浏览器控制台错误
2. 查看服务器日志
3. 测试OSS配置
4. 检查数据库连接

---

**数据上传功能已完成！开始测试吧！** 🚀

