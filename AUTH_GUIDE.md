# ğŸ” ç”¨æˆ·è®¤è¯åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

- âœ… ç”¨æˆ·æ³¨å†Œ
- âœ… ç”¨æˆ·ç™»å½•
- âœ… ä¼šè¯ç®¡ç†
- âœ… å¯†ç åŠ å¯†
- âœ… è‡ªåŠ¨ç™»å½•
- âœ… é€€å‡ºç™»å½•
- âœ… è¡¨å•éªŒè¯
- âœ… é”™è¯¯æç¤º

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### 1. åŒæ­¥æ•°æ®åº“

é¦–å…ˆç¡®ä¿æ•°æ®åº“å·²æ›´æ–°ï¼š

```bash
# é‡æ–°ç”ŸæˆPrismaå®¢æˆ·ç«¯
npx prisma generate

# åŒæ­¥æ•°æ®åº“ï¼ˆä¼šåˆ›å»ºæ–°çš„è¡¨ï¼‰
npx prisma db push
```

### 2. å¯åŠ¨é¡¹ç›®

```bash
pnpm dev
```

### 3. æµ‹è¯•æµç¨‹

#### æ­¥éª¤1ï¼šæ³¨å†Œæ–°ç”¨æˆ·

è®¿é—®ï¼šhttp://localhost:3000/auth/register

å¡«å†™ä¿¡æ¯ï¼š
- å§“åï¼šæµ‹è¯•ç”¨æˆ·
- é‚®ç®±ï¼štest@example.com
- å¯†ç ï¼š12345678ï¼ˆè‡³å°‘8ä½ï¼‰
- ç¡®è®¤å¯†ç ï¼š12345678

ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®

âœ… **é¢„æœŸç»“æœ**ï¼š
- çœ‹åˆ°"æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬..."æç¤º
- è‡ªåŠ¨è·³è½¬åˆ°å·¥ä½œå° `/dashboard`

#### æ­¥éª¤2ï¼šæŸ¥çœ‹è®¤è¯çŠ¶æ€

è®¿é—®ï¼šhttp://localhost:3000/test-auth

âœ… **é¢„æœŸç»“æœ**ï¼š
- æ˜¾ç¤º"å·²ç™»å½•"çŠ¶æ€
- çœ‹åˆ°ç”¨æˆ·IDã€é‚®ç®±ã€å§“å
- çœ‹åˆ°å®Œæ•´çš„Sessionæ•°æ®

#### æ­¥éª¤3ï¼šé€€å‡ºç™»å½•

åœ¨æµ‹è¯•é¡µé¢ç‚¹å‡»"é€€å‡ºç™»å½•"æŒ‰é’®

âœ… **é¢„æœŸç»“æœ**ï¼š
- è·³è½¬åˆ°ç™»å½•é¡µ
- è®¤è¯çŠ¶æ€å˜ä¸º"æœªç™»å½•"

#### æ­¥éª¤4ï¼šé‡æ–°ç™»å½•

è®¿é—®ï¼šhttp://localhost:3000/auth/login

è¾“å…¥ä¹‹å‰æ³¨å†Œçš„è´¦å·ï¼š
- é‚®ç®±ï¼štest@example.com
- å¯†ç ï¼š12345678

ç‚¹å‡»"ç™»å½•"

âœ… **é¢„æœŸç»“æœ**ï¼š
- æˆåŠŸç™»å½•
- è·³è½¬åˆ°å·¥ä½œå°

---

## ğŸ“‹ æ•°æ®åº“æŸ¥çœ‹

### ä½¿ç”¨Prisma Studio

```bash
npx prisma studio
```

è®¿é—®ï¼šhttp://localhost:5555

åœ¨å·¦ä¾§é€‰æ‹© `User` è¡¨ï¼Œå¯ä»¥çœ‹åˆ°ï¼š
- æ³¨å†Œçš„ç”¨æˆ·ä¿¡æ¯
- åŠ å¯†åçš„å¯†ç ï¼ˆbcrypt hashï¼‰
- åˆ›å»ºæ—¶é—´ç­‰

---

## ğŸ”§ å·²åˆ›å»ºçš„æ–‡ä»¶

### æ ¸å¿ƒé…ç½®

1. **`lib/auth.ts`** - NextAuthé…ç½®
   - å‡­è¯è®¤è¯æä¾›è€…
   - JWTä¼šè¯ç­–ç•¥
   - å›è°ƒå‡½æ•°

2. **`lib/session.ts`** - Sessionå·¥å…·å‡½æ•°
   - `getCurrentUser()` - è·å–å½“å‰ç”¨æˆ·
   - `requireAuth()` - è¦æ±‚ç™»å½•

### APIè·¯ç”±

3. **`app/api/auth/[...nextauth]/route.ts`** - NextAuth API
4. **`app/api/auth/register/route.ts`** - æ³¨å†ŒAPI

### é¡µé¢

5. **`app/(auth)/auth/login/page.tsx`** - ç™»å½•é¡µï¼ˆå·²æ›´æ–°ï¼‰
6. **`app/(auth)/auth/register/page.tsx`** - æ³¨å†Œé¡µï¼ˆå·²æ›´æ–°ï¼‰
7. **`app/(dashboard)/test-auth/page.tsx`** - æµ‹è¯•é¡µ

### å…¶ä»–

8. **`components/providers.tsx`** - SessionProvideråŒ…è£…
9. **`types/next-auth.d.ts`** - TypeScriptç±»å‹å®šä¹‰
10. **`prisma/schema.prisma`** - æ•°æ®åº“Schemaï¼ˆå·²æ›´æ–°ï¼‰

---

## ğŸ¯ åŠŸèƒ½è¯¦è§£

### æ³¨å†Œæµç¨‹

```
ç”¨æˆ·å¡«å†™è¡¨å•
  â†“
å‰ç«¯éªŒè¯ï¼ˆå¯†ç é•¿åº¦ã€é‚®ç®±æ ¼å¼ï¼‰
  â†“
è°ƒç”¨ /api/auth/register
  â†“
æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
  â†“
ä½¿ç”¨bcryptåŠ å¯†å¯†ç 
  â†“
ä¿å­˜åˆ°æ•°æ®åº“
  â†“
è‡ªåŠ¨ç™»å½•
  â†“
è·³è½¬åˆ°å·¥ä½œå°
```

### ç™»å½•æµç¨‹

```
ç”¨æˆ·è¾“å…¥é‚®ç®±å¯†ç 
  â†“
è°ƒç”¨ signIn('credentials', ...)
  â†“
NextAuthè°ƒç”¨authorizeå‡½æ•°
  â†“
ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
  â†“
éªŒè¯å¯†ç ï¼ˆbcrypt.compareï¼‰
  â†“
ç”ŸæˆJWT token
  â†“
åˆ›å»ºSession
  â†“
è·³è½¬åˆ°å·¥ä½œå°
```

### Sessionç®¡ç†

```
ç”¨æˆ·å·²ç™»å½•
  â†“
Sessionå­˜å‚¨åœ¨Cookieä¸­ï¼ˆJWTï¼‰
  â†“
æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨éªŒè¯
  â†“
å¯é€šè¿‡useSession()è·å–ç”¨æˆ·ä¿¡æ¯
  â†“
å¯é€šè¿‡getCurrentUser()åœ¨æœåŠ¡ç«¯è·å–
```

---

## ğŸ’¡ å¦‚ä½•åœ¨å…¶ä»–é¡µé¢ä½¿ç”¨

### å®¢æˆ·ç«¯ç»„ä»¶

```tsx
'use client'

import { useSession } from 'next-auth/react'

export default function MyPage() {
  const { data: session, status } = useSession()
  
  if (status === 'loading') {
    return <div>åŠ è½½ä¸­...</div>
  }
  
  if (!session) {
    return <div>è¯·å…ˆç™»å½•</div>
  }
  
  return (
    <div>
      æ¬¢è¿ï¼Œ{session.user.name}ï¼
      <p>é‚®ç®±ï¼š{session.user.email}</p>
    </div>
  )
}
```

### æœåŠ¡ç«¯ç»„ä»¶

```tsx
import { getCurrentUser } from '@/lib/session'
import { redirect } from 'next/navigation'

export default async function MyPage() {
  const user = await getCurrentUser()
  
  if (!user) {
    redirect('/auth/login')
  }
  
  return (
    <div>
      æ¬¢è¿ï¼Œ{user.name}ï¼
    </div>
  )
}
```

### APIè·¯ç”±

```tsx
import { getCurrentUser } from '@/lib/session'
import { NextResponse } from 'next/server'

export async function GET() {
  const user = await getCurrentUser()
  
  if (!user) {
    return NextResponse.json(
      { error: 'æœªç™»å½•' },
      { status: 401 }
    )
  }
  
  // ä½¿ç”¨ user.id, user.email ç­‰
  return NextResponse.json({ user })
}
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

- âœ… **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨bcryptï¼ˆ10è½®ç›å€¼ï¼‰
- âœ… **JWTä¼šè¯**ï¼šå®‰å…¨çš„tokenæœºåˆ¶
- âœ… **è¾“å…¥éªŒè¯**ï¼šå‰åç«¯åŒé‡éªŒè¯
- âœ… **SQLæ³¨å…¥é˜²æŠ¤**ï¼šPrisma ORMé˜²æŠ¤
- âœ… **XSSé˜²æŠ¤**ï¼šNext.jsè‡ªåŠ¨è½¬ä¹‰
- âœ… **CSRFé˜²æŠ¤**ï¼šNextAuthå†…ç½®é˜²æŠ¤

---

## ğŸ“± å·²æµ‹è¯•åŠŸèƒ½

- âœ… æ³¨å†Œæ–°ç”¨æˆ·
- âœ… å¯†ç éªŒè¯ï¼ˆé•¿åº¦ã€åŒ¹é…ï¼‰
- âœ… é‚®ç®±é‡å¤æ£€æµ‹
- âœ… è‡ªåŠ¨ç™»å½•
- âœ… æ‰‹åŠ¨ç™»å½•
- âœ… é”™è¯¯æç¤º
- âœ… æˆåŠŸæç¤º
- âœ… SessionæŒä¹…åŒ–
- âœ… é€€å‡ºç™»å½•

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ³¨å†Œåæ²¡æœ‰è·³è½¬ï¼Ÿ
A: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼Œå¯èƒ½æ˜¯APIè°ƒç”¨å¤±è´¥ã€‚ç¡®ä¿æ•°æ®åº“å·²æ­£ç¡®é…ç½®ã€‚

### Q2: ç™»å½•æç¤º"é‚®ç®±æˆ–å¯†ç é”™è¯¯"ï¼Ÿ
A: ç¡®ä¿ä½¿ç”¨æ³¨å†Œæ—¶çš„é‚®ç®±å’Œå¯†ç ã€‚å¯ä»¥åœ¨Prisma Studioä¸­æŸ¥çœ‹æ•°æ®åº“ã€‚

### Q3: Sessionæ˜¾ç¤ºæœªç™»å½•ï¼Ÿ
A: æ£€æŸ¥Cookieæ˜¯å¦è¢«é˜»æ­¢ï¼Œæˆ–æ¸…é™¤æµè§ˆå™¨Cookieåé‡è¯•ã€‚

### Q4: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ
A: ç¡®ä¿PostgreSQLå®¹å™¨æ­£åœ¨è¿è¡Œï¼š`docker ps`

---

## ğŸ‰ ä¸‹ä¸€æ­¥

ç°åœ¨ç”¨æˆ·è®¤è¯ç³»ç»Ÿå·²å®Œæˆï¼æ¥ä¸‹æ¥å¯ä»¥ï¼š

1. âœ… **ä¿æŠ¤å…¶ä»–é¡µé¢**
   - è®©å·¥ä½œå°ã€æ•°æ®é›†ç­‰é¡µé¢è¦æ±‚ç™»å½•

2. âœ… **å®ç°æ•°æ®ä¸Šä¼ **
   - å°†ä¸Šä¼ çš„æ•°æ®å…³è”åˆ°å½“å‰ç”¨æˆ·

3. âœ… **é›†æˆDify AI**
   - ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºç‹¬ç«‹çš„å¯¹è¯

4. âœ… **ç”¨æˆ·è®¾ç½®**
   - ä¿®æ”¹ä¸ªäººä¿¡æ¯
   - ä¿®æ”¹å¯†ç 
   - ä¸Šä¼ å¤´åƒ

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [NextAuth.jsæ–‡æ¡£](https://next-auth.js.org/)
- [Prismaæ–‡æ¡£](https://www.prisma.io/docs)
- [bcryptæ–‡æ¡£](https://github.com/kelektiv/node.bcrypt.js)

---

**è®¤è¯ç³»ç»Ÿå·²å®Œæˆï¼å¼€å§‹æµ‹è¯•å§ï¼** ğŸŠ

